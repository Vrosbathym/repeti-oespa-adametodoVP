<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S√≠ntese AI: Revisor de Conte√∫do Otimizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      @keyframes modal-scale-in {
          from { transform: scale(0.95); opacity: 0; }
          to { transform: scale(1); opacity: 1; }
        }
        .animate-modal-scale-in {
          animation: modal-scale-in 0.3s forwards cubic-bezier(0.165, 0.84, 0.44, 1);
        }
    </style>
    <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react/": "https://esm.sh/react@^19.1.0/",
        "react": "https://esm.sh/react@^19.1.0",
        "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
        "@google/genai": "https://esm.sh/@google/genai@^1.3.0",
        "jspdf": "https://esm.sh/jspdf@^2.5.1"
      }
    }
    </script>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript" data-type="module">
      import React, { useState, useCallback, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI } from "@google/genai"; // Using user's original import
      import jsPDF from 'jspdf';

      // --- START OF ICON COMPONENTS ---
      const BrainCircuitIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M12 2a4.5 4.5 0 0 0-4.5 4.5V10H6v4h1.5v2.5A4.5 4.5 0 0 0 12 21a4.5 4.5 0 0 0 4.5-4.5V14H18v-4h-1.5V6.5A4.5 4.5 0 0 0 12 2Z" /><path d="M6 10h0" /><path d="M18 10h0" /><path d="M12 5.5A2.5 2.5 0 0 0 9.5 8" /><path d="M14.5 8A2.5 2.5 0 0 0 12 5.5" /><path d="M12 18.5A2.5 2.5 0 0 0 14.5 16" /><path d="M9.5 16A2.5 2.5 0 0 0 12 18.5" /><path d="M6.5 12H5" /><path d="M17.5 12H19" /><path d="M12 12h4.5" /><path d="M12 12H7.5" /><path d="M10 14h4" /><path d="M10 10h4" />
        </svg>
      );
      const BookOpenIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg>
      );
      const SparklesIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" {...props}>
          <path d="M12 .5l1.55 4.75h4.95l-3.8 3.45 1.55 4.75L12 10.5l-3.25 2.95 1.55-4.75-3.8-3.45h4.95L12 .5zm0 8l1.55 4.75h4.95l-3.8 3.45 1.55 4.75L12 18.5l-3.25 2.95 1.55-4.75-3.8-3.45h4.95L12 8.5zM4.5 17l1.55 4.75h4.95l-3.8 3.45L8.75 30l-3.25-2.95-3.25 2.95 1.55-4.75-3.8-3.45h4.95L4.5 17zm15 0l1.55 4.75h4.95l-3.8 3.45 1.55 4.75-3.25-2.95-3.25 2.95 1.55-4.75-3.8-3.45h4.95L19.5 17z" opacity="0.5" /><path d="M12 5l1 3h3.2l-2.6 2.3.9 3.2L12 11.3l-2.5 2.2.9-3.2L7.8 8H11l1-3z" />
        </svg>
      );
      const UploadIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      );
      const KeyIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path><circle cx="8.5" cy="15.5" r="2.5"></circle>
        </svg>
      );
      const DocumentTextIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line>
        </svg>
      );
      const ClipboardIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
      );
      const CheckCircleIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      );
      const DownloadIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      );
      const ExclamationTriangleIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      );
      // --- END OF ICON COMPONENTS ---

      // --- START OF geminiAIService.ts LOGIC ---
      const geminiModelName = "gemini-2.5-flash-preview-04-17"; 

      async function generateSummaryService(content) {
        // **AJUSTE ADICIONADO AQUI:** Verifica√ß√£o expl√≠cita do conte√∫do no in√≠cio da fun√ß√£o.
        if (!content || typeof content !== 'string' || !content.trim()) {
          console.error("generateSummaryService foi chamada com conte√∫do inv√°lido ou vazio. Conte√∫do recebido:", content);
          // Este erro ser√° exibido na interface do usu√°rio.
          throw new Error("O conte√∫do fornecido para an√°lise est√° vazio ou √© inv√°lido. Por favor, insira ou anexe um texto v√°lido.");
        }
        // Linha de depura√ß√£o sugerida anteriormente (mantenha se quiser verificar)
        console.log("Texto recebido em generateSummaryService:", content);

        const userApiKey = localStorage.getItem('userGeminiApiKey');
        if (!userApiKey) {
          throw new Error("Nenhuma chave de API do Gemini foi configurada. Por favor, clique no √≠cone de chave üîë para adicionar sua chave.");
        }
        const ai = new GoogleGenAI({ apiKey: userApiKey }); 

        const newPromptText = `
Voc√™ √© um assistente de IA especializado em criar materiais de estudo otimizados para reten√ß√£o de conte√∫do usando o m√©todo de REPETI√á√ÉO ESPA√áADA e na elabora√ß√£o de QUEST√ïES para autoavalia√ß√£o.
Sua tarefa √© analisar o texto fornecido e gerar dois tipos de material:

PARTE 1: CONTE√öDO ESTRUTURADO PARA REPETI√á√ÉO ESPA√áADA
Identifique os conceitos, fatos e informa√ß√µes mais importantes do texto. Para cada um deles, apresente-o no seguinte formato, ideal para ser transformado em flashcards ou usado em sistemas de repeti√ß√£o espa√ßada:

**Conceito/Fato Principal: [Nome do Conceito/Fato em Negrito]**
* **Ponto-chave/Pergunta para Lembrar:** [Uma pergunta direta ou um ponto-chave que o estudante deve ser capaz de responder ou explicar sobre o conceito/fato. Ex: "Quais s√£o as tr√™s principais caracter√≠sticas de X?" ou "Defina Y."]
* **Resposta/Informa√ß√£o Essencial:** [A resposta concisa e completa para a pergunta acima, ou os detalhes essenciais do ponto-chave. Ideal para o 'verso' de um flashcard.]
---

[Repita o formato acima para cada conceito/fato principal identificado no texto. Use '---' como separador entre cada bloco.]

PARTE 2: QUEST√ïES PARA AUTOAVALIA√á√ÉO
Com base no conte√∫do integral do texto fornecido, gere uma lista de 5 a 7 quest√µes dissertativas ou de m√∫ltipla escolha que permitam ao estudante testar seu conhecimento e compreens√£o do material. Se gerar quest√µes de m√∫ltipla escolha, indique a resposta correta entre par√™nteses ao lado da op√ß√£o correta, por exemplo: (Correta).

### Quest√µes de Revis√£o

[Liste as quest√µes aqui. Exemplo:
1.  Explique o impacto de A em B, com base no texto.
2.  Quais s√£o os principais desafios mencionados para a implementa√ß√£o de C?
3.  (M√∫ltipla Escolha) Qual das seguintes afirma√ß√µes sobre Z √© VERDADEIRA de acordo com o texto?
    a) Op√ß√£o 1
    b) Op√ß√£o 2 (Correta)
    c) Op√ß√£o 3
    d) Op√ß√£o 4
]

INSTRU√á√ïES IMPORTANTES:
-   Na PARTE 1, seja conciso mas completo na "Resposta/Informa√ß√£o Essencial".
-   Use Markdown para toda a formata√ß√£o (negrito, listas, separadores).
-   O output DEVE come√ßar diretamente com o primeiro "**Conceito/Fato Principal:**". N√£o inclua nenhuma frase introdut√≥ria sua antes disso.
-   Certifique-se de que as quest√µes na PARTE 2 cubram diferentes aspectos do texto e incentivem o pensamento cr√≠tico, n√£o apenas a memoriza√ß√£o simples.

Texto para analisar e estruturar:
---
${content}
---
`;
        // Linha de depura√ß√£o sugerida anteriormente (mantenha se quiser verificar)
        console.log("Prompt completo enviado para a API:", newPromptText); 
        
        try {
          const response = await ai.models.generateContent({ model: geminiModelName, contents: newPromptText });
          let processedText = response.text; 

          if (processedText === undefined || processedText === null) { // Verifica√ß√£o mais robusta
            console.error("A API retornou 'response.text' como undefined ou null. Resposta completa:", response);
            throw new Error("A API n√£o retornou texto na resposta (response.text est√° vazio ou nulo). Verifique o console do navegador para a resposta completa da API.");
          }
          
          const commonIntros = [
            "Okay, here is the material based on your request:", "Okay, here are the study materials:",
            "Aqui est√° o material de estudo:", "Aqui est√£o os materiais de estudo otimizados:",
            "Claro, aqui est√° o material no formato solicitado:"
          ];
          for (const intro of commonIntros) {
            if (processedText.toLowerCase().startsWith(intro.toLowerCase())) {
              processedText = processedText.substring(intro.length).trimStart();
              break;
            }
          }
          processedText = processedText.replace(/^\s+/, "");

          if (processedText && processedText.trim()) { 
            return processedText.trim(); 
          } else { 
            console.warn("API retornou texto, mas ele ficou vazio ap√≥s o processamento. Texto original:", response.text);
            throw new Error("A API n√£o retornou nenhum conte√∫do de resumo √∫til ap√≥s o processamento."); 
          }
        } catch (error) {
          console.error("Erro ao chamar ou processar a API Gemini:", error);
          let detailedErrorMessage = (error instanceof Error && error.message) ? error.message : "Falha ao comunicar com a API do Gemini. Verifique a chave, conex√£o e o console para mais detalhes.";
          
          // Mantendo a l√≥gica de mensagens de erro espec√≠ficas do seu c√≥digo original, se aplic√°vel
          if (error instanceof Error) {
            if (error.message.includes("API key not valid") || error.message.includes("invalid api key")) {
              detailedErrorMessage = "Sua chave de API do Gemini √© inv√°lida. Por favor, verifique-a e tente novamente.";
            } else if (error.message.includes("quota")) {
              detailedErrorMessage = "Sua cota da API Gemini foi excedida. Tente novamente mais tarde ou verifique sua conta Google AI Studio.";
            } else if (error.message.includes("permission denied")) {
              detailedErrorMessage = `Permiss√£o negada. Verifique se sua chave de API tem as permiss√µes necess√°rias para o modelo '${geminiModelName}'.`;
            } else if (error.message.includes("SAFETY") || (error.toString && error.toString().includes("SAFETY"))) {
                detailedErrorMessage = "O conte√∫do n√£o p√¥de ser gerado devido √†s pol√≠ticas de seguran√ßa. Tente reformular o texto de entrada.";
            }
          }
          throw new Error(detailedErrorMessage);
        }
      }
      // --- END OF geminiAIService.ts LOGIC ---

      // --- START OF UI COMPONENTS ---
      // (LoadingIndicator, ErrorMessageDisplay, ApiKeyModal permanecem os mesmos)
      const LoadingIndicator = () => (
        <div className="flex flex-col items-center justify-center p-8 bg-slate-800 shadow-xl rounded-xl border border-slate-700">
          <svg className="animate-spin h-10 w-10 text-sky-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          <p className="text-slate-300 text-lg">Gerando material de estudo...</p><p className="text-slate-400 text-sm">Isso pode levar alguns instantes.</p>
        </div>
      );

      const ErrorMessageDisplay = ({ message }) => (
        <div className="bg-red-900/30 border border-red-700 text-red-300 px-4 py-3 rounded-lg relative shadow-md" role="alert">
          <div className="flex items-center"><ExclamationTriangleIcon className="h-6 w-6 text-red-400 mr-3" /><div><strong className="font-bold">Ocorreu um Erro!</strong><span className="block sm:inline ml-1">{message}</span></div></div>
        </div>
      );

      const ApiKeyModal = ({ isOpen, onClose, onApiKeyUpdated }) => {
        const [apiKeyInput, setApiKeyInput] = useState('');
        const [currentApiKeyMasked, setCurrentApiKeyMasked] = useState(null);
        const [saveStatus, setSaveStatus] = useState('idle'); 
        const [errorMessage, setErrorMessage] = useState(null);

        const maskApiKey = (key) => key.length <= 8 ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : `‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢${key.substring(key.length - 4)}`;
        const loadAndMaskKey = useCallback(() => {
          const storedKey = localStorage.getItem('userGeminiApiKey');
          if (storedKey) { setCurrentApiKeyMasked(maskApiKey(storedKey)); setApiKeyInput(''); } else { setCurrentApiKeyMasked(null); }
        }, []);

        useEffect(() => { if (isOpen) { loadAndMaskKey(); setSaveStatus('idle'); setErrorMessage(null); } }, [isOpen, loadAndMaskKey]);

        const handleSaveKey = () => {
          if (!apiKeyInput.trim()) { setErrorMessage('Por favor, insira uma chave de API v√°lida.'); setSaveStatus('error'); return; }
          try {
            localStorage.setItem('userGeminiApiKey', apiKeyInput.trim()); setSaveStatus('success'); setErrorMessage(null); onApiKeyUpdated(); loadAndMaskKey();
            setTimeout(() => { setSaveStatus('idle'); onClose(); }, 1500);
          } catch (error) { setErrorMessage('N√£o foi poss√≠vel salvar a chave. Verifique permiss√µes.'); setSaveStatus('error'); }
        };
        const handleClearKey = () => {
          try { localStorage.removeItem('userGeminiApiKey'); setApiKeyInput(''); setCurrentApiKeyMasked(null); setSaveStatus('idle'); setErrorMessage(null); onApiKeyUpdated(); }
          catch (error) { setErrorMessage('N√£o foi poss√≠vel limpar a chave.'); setSaveStatus('error'); }
        };

        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity duration-300 ease-out animate-modal-scale-in" onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="apiKeyModalTitle">
            <div className="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-slate-700 w-full max-w-md transform transition-all duration-300 ease-out" onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-6"><div className="flex items-center"><KeyIcon className="h-7 w-7 text-sky-400 mr-3" /><h2 id="apiKeyModalTitle" className="text-2xl font-semibold text-slate-100">Configurar Chave de API</h2></div><button onClick={onClose} className="p-1 text-slate-500 hover:text-slate-300 rounded-full hover:bg-slate-700" aria-label="Fechar modal"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-7 h-7"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
              {currentApiKeyMasked && saveStatus !== 'success' && (<div className="mb-4 p-3 bg-slate-700/50 rounded-lg"><p className="text-sm text-slate-400">Chave de API atual:</p><p className="text-lg text-sky-300 font-mono tracking-wider">{currentApiKeyMasked}</p><button onClick={handleClearKey} className="mt-2 text-xs text-amber-500 hover:text-amber-400 hover:underline">Limpar Chave Salva</button></div>)}
              {saveStatus !== 'success' && (<div className="space-y-4"><p className="text-slate-400 text-sm">{currentApiKeyMasked ? "Para alterar, insira uma nova chave abaixo." : "Insira sua chave de API do Google Gemini para come√ßar a usar o aplicativo."}</p><div><label htmlFor="apiKeyInput" className="block text-sm font-medium text-slate-300 mb-1">Sua Chave de API Gemini</label><input type="password" id="apiKeyInput" value={apiKeyInput} onChange={(e) => { setApiKeyInput(e.target.value); if(saveStatus !== 'idle') setSaveStatus('idle'); if(errorMessage) setErrorMessage(null); }} placeholder="Cole sua chave aqui" className="w-full p-3 bg-slate-700 text-slate-200 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 placeholder-slate-500" /></div><button onClick={handleSaveKey} className="w-full flex items-center justify-center px-6 py-3 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg">Salvar Chave</button></div>)}
              {saveStatus === 'success' && (<div id="api-key-status-success" role="status" className="mt-4 p-4 bg-green-700/30 border border-green-600 rounded-lg text-center"><CheckCircleIcon className="h-8 w-8 text-green-400 mx-auto mb-2" /><p className="text-green-300 font-medium">Chave de API salva com sucesso!</p></div>)}
              {saveStatus === 'error' && errorMessage && (<div id="api-key-status-error" role="alert" className="mt-4 p-4 bg-red-800/30 border border-red-700 rounded-lg text-center"><ExclamationTriangleIcon className="h-8 w-8 text-red-400 mx-auto mb-2" /><p className="text-red-300 font-medium">{errorMessage}</p></div>)}
              <p className="mt-6 text-xs text-slate-500 text-center">Sua chave de API √© armazenada apenas no seu navegador. Obtenha uma chave no <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline">Google AI Studio</a>.</p>
            </div>
          </div>
        );
      };

      // (SummaryOutputArea e ContentInputArea permanecem com a l√≥gica de PDF e UI da vers√£o anterior,
      //  que carregou a p√°gina mas gerou conte√∫do errado. A l√≥gica do PDF foi mantida.)
      const SummaryOutputArea = ({ summary }) => {
        const [copied, setCopied] = useState(false);
        const [isDownloadingPdf, setIsDownloadingPdf] = useState(false);
        const handleCopy = async () => { try { await navigator.clipboard.writeText(summary); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch (err) { console.error("Failed to copy text: ", err); alert("Erro ao copiar texto. Tente manualmente."); } };
        
        const addPdfFooterInternal = (pdfInstance, pageHeight, pageWidth, marginValue) => {
            const originalFontSize = pdfInstance.getFontSize(); const originalFont = pdfInstance.getFont();
            pdfInstance.setFontSize(9); pdfInstance.setFont('helvetica', 'italic'); pdfInstance.setTextColor(100);
            pdfInstance.text("Desenvolvido por Vinicius de Paiva Marti", pageWidth / 2, pageHeight - marginValue / 2, { align: 'center' });
            pdfInstance.setFontSize(originalFontSize); pdfInstance.setFont(originalFont.fontName, originalFont.fontStyle); pdfInstance.setTextColor(0);
        };

        const handleDownloadPdf = async () => {
          if (!summary) return; setIsDownloadingPdf(true);
          try {
            const pdf = new jsPDF('p', 'pt', 'a4'); const pageHeight = pdf.internal.pageSize.getHeight(); const pageWidth = pdf.internal.pageSize.getWidth(); const margin = 40; const contentWidth = pageWidth - 2 * margin; const footerSpace = 30; let yPosition = margin;
            const baseFontSize = 10.5; const h1FontSize = 16; const h2FontSize = 13; const lineHeightMultiplier = 1.4; const paragraphSpacing = baseFontSize * 0.7;
            const addFooterAndNewPageIfNeeded = (currentY, itemHeight) => { if (currentY + itemHeight > pageHeight - margin - footerSpace) { addPdfFooterInternal(pdf, pageHeight, pageWidth, margin); pdf.addPage(); return margin; } return currentY; };
            
            const summaryLines = summary.split('\n');
            for (const line of summaryLines) {
              const trimmedLine = line.trimEnd(); 
              pdf.setFont('helvetica', 'normal'); pdf.setFontSize(baseFontSize); 

              if (trimmedLine.startsWith("**Conceito/Fato Principal:")) {
                let title = trimmedLine.substring("**Conceito/Fato Principal:".length).trim();
                title = title.endsWith("**") ? title.substring(0, title.length - 2).trim() : title;
                pdf.setFontSize(h1FontSize - 2); 
                pdf.setFont('helvetica', 'bold'); pdf.setTextColor(40,40,40); 
                const dims = pdf.getTextDimensions(title, {maxWidth: contentWidth, fontSize: h1FontSize - 2}); 
                yPosition = addFooterAndNewPageIfNeeded(yPosition, dims.h * lineHeightMultiplier); 
                pdf.text(title, margin, yPosition, {maxWidth: contentWidth}); 
                yPosition += dims.h * lineHeightMultiplier + paragraphSpacing * 0.7; 
                pdf.setTextColor(0); pdf.setFont('helvetica', 'normal');
              } else if (trimmedLine.startsWith("### Quest√µes de Revis√£o")) { 
                const title = trimmedLine.substring(4).trim(); 
                pdf.setFontSize(h1FontSize); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(50,50,50); 
                const dims = pdf.getTextDimensions(title, {maxWidth: contentWidth, fontSize: h1FontSize}); 
                yPosition = addFooterAndNewPageIfNeeded(yPosition, dims.h * lineHeightMultiplier); 
                pdf.text(title, margin, yPosition, {maxWidth: contentWidth}); 
                yPosition += dims.h * lineHeightMultiplier + paragraphSpacing * 0.8; 
                pdf.setTextColor(0); pdf.setFont('helvetica', 'normal');
              } else if (trimmedLine.startsWith("---")) { 
                 yPosition = addFooterAndNewPageIfNeeded(yPosition, 10 + paragraphSpacing * 0.2);
                 pdf.setDrawColor(200, 200, 200); 
                 pdf.line(margin, yPosition, pageWidth - margin, yPosition);
                 yPosition += 10 + paragraphSpacing * 0.2;
              } else if (trimmedLine.startsWith("* **Ponto-chave/Pergunta para Lembrar:**") || trimmedLine.startsWith("* **Resposta/Informa√ß√£o Essencial:**")) {
                let itemTextContent = trimmedLine.substring(2).trim(); 
                let prefix = "";
                
                if (itemTextContent.startsWith("**Ponto-chave/Pergunta para Lembrar:**")) {
                    prefix = "Ponto-chave/Pergunta:";
                    itemTextContent = itemTextContent.substring("**Ponto-chave/Pergunta para Lembrar:**".length).trim();
                } else if (itemTextContent.startsWith("**Resposta/Informa√ß√£o Essencial:**")) {
                    prefix = "Resposta Essencial:";
                    itemTextContent = itemTextContent.substring("**Resposta/Informa√ß√£o Essencial:**".length).trim();
                }
                
                const indent = margin + 10;
                pdf.setFontSize(baseFontSize);
                
                yPosition = addFooterAndNewPageIfNeeded(yPosition, 0); 
                pdf.setFont('helvetica', 'bold');
                pdf.text(prefix, indent, yPosition);
                
                const prefixWidth = pdf.getTextWidth(prefix + " ");
                pdf.setFont('helvetica', 'normal');
                const textLines = pdf.splitTextToSize(itemTextContent, contentWidth - (indent - margin) - prefixWidth);
                for (let i = 0; i < textLines.length; i++) {
                  const lineDims = pdf.getTextDimensions(textLines[i],{fontSize: baseFontSize});
                  if (i === 0) {
                     pdf.text(textLines[i], indent + prefixWidth, yPosition);
                     yPosition += lineDims.h * lineHeightMultiplier;
                  } else {
                     yPosition = addFooterAndNewPageIfNeeded(yPosition, lineDims.h * lineHeightMultiplier);
                     pdf.text(textLines[i], indent + prefixWidth, yPosition);
                     yPosition += lineDims.h * lineHeightMultiplier;
                  }
                }
                yPosition += paragraphSpacing * 0.1; 
              } else if (trimmedLine.match(/^\s*\d+\.\s/)) { 
                const match = trimmedLine.match(/^(\s*)(\d+\.)\s(.*)/); 
                if (match) { 
                  const [, sp, num, txt] = match; 
                  const indentLevel = Math.floor(sp.length / 2); 
                  const indent = margin + (indentLevel * 10); 
                  pdf.setFontSize(baseFontSize); pdf.setFont('helvetica', 'normal'); 
                  const numDim = pdf.getTextDimensions(num, {fontSize: baseFontSize}); 
                  yPosition = addFooterAndNewPageIfNeeded(yPosition, numDim.h * lineHeightMultiplier); 
                  pdf.text(num, indent , yPosition); 
                  
                  const questionTextIndent = indent + pdf.getTextWidth(num + " ");
                  const itemLines = pdf.splitTextToSize(txt, contentWidth - (questionTextIndent - margin)); 
                  for(let i=0; i < itemLines.length; i++) { 
                    const lineDims = pdf.getTextDimensions(itemLines[i], {fontSize: baseFontSize}); 
                    if(i===0) {
                        pdf.text(itemLines[i], questionTextIndent, yPosition);
                    } else {
                        yPosition = addFooterAndNewPageIfNeeded(yPosition, lineDims.h * lineHeightMultiplier);
                        pdf.text(itemLines[i], questionTextIndent, yPosition);
                    }
                     if (i < itemLines.length - 1) yPosition += lineDims.h * lineHeightMultiplier; else if (itemLines.length > 0) yPosition += lineDims.h * lineHeightMultiplier;
                  } 
                } 
              } else if (trimmedLine) { 
                const indent = (trimmedLine.startsWith("    ") || /^\s{2,}[a-d]\)/.test(trimmedLine)) ? margin + 20 : margin;
                pdf.setFontSize(baseFontSize); pdf.setFont('helvetica', 'normal'); 
                const textLines = pdf.splitTextToSize(trimmedLine.trimStart(), contentWidth - (indent - margin) ); 
                for (const textLine of textLines) { 
                  const dims = pdf.getTextDimensions(textLine, {fontSize: baseFontSize}); 
                  yPosition = addFooterAndNewPageIfNeeded(yPosition, dims.h * lineHeightMultiplier); 
                  pdf.text(textLine, indent, yPosition); 
                  yPosition += dims.h * lineHeightMultiplier; 
                } 
                yPosition += paragraphSpacing * 0.3;
              } else { 
                pdf.setFontSize(baseFontSize); pdf.setFont('helvetica', 'normal'); 
                const emptyLineH = pdf.getTextDimensions(" ", {fontSize: baseFontSize}).h * lineHeightMultiplier; 
                yPosition = addFooterAndNewPageIfNeeded(yPosition, emptyLineH * 0.5); 
                yPosition += emptyLineH * 0.5; 
              }
            }
            addPdfFooterInternal(pdf, pageHeight, pageWidth, margin); pdf.save('Material_Estudo_Sintese_AI.pdf');
          } catch (e) { console.error("PDF gen error:", e); alert("Erro ao gerar PDF. A formata√ß√£o pode n√£o estar otimizada para este novo tipo de resumo."); } finally { setIsDownloadingPdf(false); }
        };
        return (
          <div className="bg-slate-800 shadow-2xl rounded-xl p-6 sm:p-8 border border-slate-700"><div className="flex flex-col sm:flex-row items-center justify-between mb-4 gap-3 sm:gap-0"><div className="flex items-center"><DocumentTextIcon className="h-7 w-7 text-emerald-400 mr-3" /><h2 className="text-2xl font-semibold text-slate-100">Material de Estudo Gerado</h2></div><div className="flex items-center gap-3"><button onClick={handleDownloadPdf} disabled={isDownloadingPdf || !summary} className="flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-slate-100 text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-colors duration-200 disabled:opacity-60 disabled:cursor-not-allowed">{isDownloadingPdf ? (<><svg className="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Gerando...</>) : (<><DownloadIcon className="h-5 w-5 mr-2" />Baixar PDF</>)}</button><button onClick={handleCopy} disabled={isDownloadingPdf} className="flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-slate-100 text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-colors duration-200 disabled:opacity-60">{copied ? (<><CheckCircleIcon className="h-5 w-5 mr-2 text-emerald-400" />Copiado!</>) : (<><ClipboardIcon className="h-5 w-5 mr-2" />Copiar</>)}</button></div></div><div className="prose prose-sm sm:prose-base prose-invert max-w-none p-4 bg-slate-700/50 rounded-lg whitespace-pre-wrap text-slate-200 overflow-x-auto">{summary}</div></div>
        );
      };

      const ContentInputArea = ({ inputText, onInputChange, onSummarize, isLoading, isApiKeySet, onConfigureApiKeyClick }) => {
        const [fileName, setFileName] = useState(null);
        const [fileError, setFileError] = useState(null);
        const fileInputRef = useRef(null);
        const acceptedFileTypes = ".txt,.md,.rtf,.html,.xml,.json,.csv,.tsv,.js,.ts,.py,.java,.c,.cpp,.cs,.php,.rb,.swift,.kt,.go,.rs,.pl,.sh,.css,.scss,.less";
        
        const handleFileChange = async (event) => {
          const files = event.target.files; if (!files || files.length === 0) return;
          setFileError(null); let combinedText = ""; const successfullyLoadedFileNames = []; let anyFileFailed = false;
          const readFileAsText = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve({ name: file.name, text: e.target.result }); reader.onerror = () => reject(new Error(`Erro ao ler o arquivo: ${file.name}`)); reader.readAsText(file); });
          const results = await Promise.allSettled(Array.from(files).map(readFileAsText));
          results.forEach(result => { if (result.status === 'fulfilled') { combinedText += (combinedText ? "\n\n---\n\n" : "") + result.value.text; successfullyLoadedFileNames.push(result.value.name); } else { anyFileFailed = true; console.error("Falha ao processar o arquivo:", result.reason); }});
          if (anyFileFailed) setFileError("Alguns arquivos n√£o puderam ser lidos. O conte√∫do dos arquivos lidos com sucesso foi carregado, se houver.");
          else setFileError(null); 
          onInputChange(combinedText); setFileName(successfullyLoadedFileNames.length > 0 ? successfullyLoadedFileNames.join(', ') : null);
          if (fileInputRef.current) fileInputRef.current.value = ""; 
        };
        const handleTextareaChange = (e) => { onInputChange(e.target.value); if (fileName) setFileName(null); if (fileError) setFileError(null); };

        return (
          <div className="bg-slate-800 shadow-2xl rounded-xl p-6 sm:p-8 border border-slate-700">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4"><div className="flex items-center mb-3 sm:mb-0"><BookOpenIcon className="h-7 w-7 text-sky-400 mr-3" /><h2 className="text-2xl font-semibold text-slate-100">Insira seu Conte√∫do</h2></div><div className="flex flex-col items-start sm:items-end"><input type="file" id="file-upload" ref={fileInputRef} className="hidden" accept={acceptedFileTypes} onChange={handleFileChange} disabled={isLoading} multiple /><label htmlFor="file-upload" className={`flex items-center justify-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-slate-100 font-medium rounded-lg shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-75 transition-all duration-200 cursor-pointer ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`} role="button" tabIndex={isLoading ? -1 : 0} onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') fileInputRef.current?.click();}}><UploadIcon className="h-5 w-5 mr-2" />Anexar Arquivo(s)</label>{fileName && (<p className="text-xs text-sky-400 mt-1 truncate max-w-xs sm:max-w-sm md:max-w-md" title={fileName}>{`Carregado${fileName.includes(',')?'s':''}: ${fileName}`}</p>)}</div></div>
            {fileError && (<p className="text-sm text-red-400 mb-3" role="alert">{fileError}</p>)}
            <p className="text-slate-400 mb-4">Cole seu texto abaixo, escreva diretamente ou anexe um ou mais arquivos. A IA ir√° process√°-lo para criar um material de estudo com foco em repeti√ß√£o espa√ßada e quest√µes para autoavalia√ß√£o.</p>
            <textarea value={inputText} onChange={handleTextareaChange} placeholder="Digite, cole o conte√∫do ou anexe arquivo(s) acima..." className="w-full h-64 p-4 bg-slate-700 text-slate-200 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow duration-200 resize-none placeholder-slate-500" disabled={isLoading} aria-label="√Årea de entrada de conte√∫do"></textarea>
            <div className="flex flex-col sm:flex-row justify-between items-center mt-4 gap-4 sm:gap-0"><div className="text-sm text-slate-500"><p>{inputText.length} caracteres</p>{!isApiKeySet && (<button onClick={onConfigureApiKeyClick} className="text-amber-400/90 hover:text-amber-300 text-xs mt-1 flex items-center underline focus:outline-none focus:ring-1 focus:ring-amber-500 rounded"><KeyIcon className="h-4 w-4 mr-1 inline-block" />Chave de API n√£o configurada. <span className="font-semibold ml-1">Clique aqui para configurar.</span></button>)}</div><button onClick={onSummarize} disabled={isLoading || !inputText.trim() || !isApiKeySet} className="flex items-center justify-center px-6 py-3 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto" aria-live="polite">{isLoading ? (<><svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processando...</>) : (<><SparklesIcon className="h-5 w-5 mr-2" />Gerar Material de Estudo</>)}</button></div>
          </div>
        );
      };

      const App = () => {
        const [inputText, setInputText] = useState('');
        const [summary, setSummary] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [userApiKeyExists, setUserApiKeyExists] = useState(false);
        const [isApiKeyModalOpen, setIsApiKeyModalOpen] = useState(false);

        useEffect(() => { const storedApiKey = localStorage.getItem('userGeminiApiKey'); setUserApiKeyExists(!!storedApiKey); }, []);
        
        const handleSummarize = useCallback(async () => {
          if (!userApiKeyExists) { setError('Por favor, configure sua chave de API do Gemini para gerar o material.'); setIsApiKeyModalOpen(true); return; }
          
          // Esta verifica√ß√£o √© crucial. Se ela n√£o estiver funcionando como esperado,
          // a fun√ß√£o generateSummaryService pode ser chamada com inputText vazio.
          if (!inputText || !inputText.trim()) { 
            setError('Por favor, insira algum conte√∫do para gerar o material de estudo.'); 
            return; 
          }
          
          setIsLoading(true); setError(null); setSummary('');
          try { 
            const result = await generateSummaryService(inputText); 
            setSummary(result); 
          }
          catch (err) { 
            if (err instanceof Error) { setError(err.message || 'Ocorreu um erro ao gerar o material de estudo.'); } 
            else { setError('Ocorreu um erro desconhecido.'); }
            console.error("Error generating study material (in App component):", err); 
          }
          finally { setIsLoading(false); }
        }, [inputText, userApiKeyExists]);

        const handleApiKeyUpdated = () => { const storedApiKey = localStorage.getItem('userGeminiApiKey'); setUserApiKeyExists(!!storedApiKey); if (error && error.includes("chave de API")) { setError(null); } };
        const toggleApiKeyModal = () => setIsApiKeyModalOpen(!isApiKeyModalOpen);

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-slate-100 flex flex-col items-center p-4 sm:p-8 selection:bg-sky-500 selection:text-white">
            <header className="w-full max-w-4xl mb-8 text-center">
              <div className="flex items-center justify-center mb-2 relative"><BrainCircuitIcon className="h-12 w-12 text-sky-400 mr-3" /><h1 className="text-4xl sm:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-cyan-300">S√≠ntese AI</h1><button onClick={toggleApiKeyModal} className="absolute right-0 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-sky-400 transition-colors" title="Configurar Chave de API Gemini" aria-label="Configurar Chave de API Gemini"><KeyIcon className="h-7 w-7" /></button></div>
              <p className="text-lg text-slate-400">Seu assistente inteligente para cria√ß√£o de material de estudo otimizado.</p>
            </header>
            <main className="w-full max-w-4xl space-y-8">
              <ContentInputArea inputText={inputText} onInputChange={setInputText} onSummarize={handleSummarize} isLoading={isLoading} isApiKeySet={userApiKeyExists} onConfigureApiKeyClick={toggleApiKeyModal} />
              {isLoading && <LoadingIndicator />}
              {error && <ErrorMessageDisplay message={error} />}
              {summary && !isLoading && <SummaryOutputArea summary={summary} />}
            </main>
            <footer className="w-full max-w-4xl mt-12 text-center text-slate-500 text-sm"><p>&copy; {new Date().getFullYear()} S√≠ntese AI. Potencializado por Gemini API.</p><p className="mt-1">Desenvolvido por Vinicius de Paiva Marti.</p></footer>
            <ApiKeyModal isOpen={isApiKeyModalOpen} onClose={toggleApiKeyModal} onApiKeyUpdated={handleApiKeyUpdated} />
          </div>
        );
      };
      // --- END OF App.tsx LOGIC ---

      // --- Mount the App ---
      const rootElement = document.getElementById('root');
      if (!rootElement) { throw new Error("Root element not found"); }
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />); 
    </script>
</body>
</html>
